generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["referentialIntegrity"]
}

datasource db {
  provider             = "mysql"
  url                  = env("DATABASE_URL")
  referentialIntegrity = "prisma"
}

model User {
  id                String      @id @default(uuid())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  name              String
  email             String      @unique
  profilePhoto      Image?      @relation(fields: [profilePhotoId], references: [id])
  profilePhotoId    String?
  firstLogin        Boolean     @default(true)
  auth0id           String?
  authorSector      Sector[]    @relation("AuthorSector")
  coAuthorSector    Sector[]    @relation("CoAuthorSector")
  authorWall        Wall[]      @relation("AuthorWall")
  coAuthorWall      Wall[]      @relation("CoAuthorWall")
  authorRoute       Route[]     @relation("AuthorRoute")
  authorTopo        Topo[]      @relation("AuthorTopo")
  coAuthorTopo      Topo[]      @relation("CoAuthorTopo")
  coAuthorRoute     Route[]     @relation("CoAuthorRoute")
  authorRoutePath   RoutePath[] @relation("AuthorRoutePath")
  coAuthorRoutePath RoutePath[] @relation("CoAuthorRoutePath")

  @@index([email])
  @@index([profilePhotoId])
}

model Roles {
  id          String        @id @default(uuid())
  name        String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  permissions Permissions[]
}

model Permissions {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  roles     Roles[]
}

model Zone {
  id         String     @id @default(uuid())
  name       String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  infoAccess InfoAccess @default(Public)
  sectors    Sector[]
  photos     Image[]
}

model Sector {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  position  Int      @default(0)
  Zone      Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  zoneId    String
  walls     Wall[]
  Author    User     @relation("AuthorSector", fields: [authorId], references: [id])
  authorId  String
  coAuthors User[]   @relation("CoAuthorSector")

  @@index([zoneId])
  @@index([authorId])
}

model Wall {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  position  Int      @default(0)
  Sector    Sector   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  sectorId  String
  topos     Topo[]
  routes    Route[]
  Author    User     @relation("AuthorWall", fields: [authorId], references: [id])
  authorId  String
  coAuthors User[]   @relation("CoAuthorWall")

  @@index([sectorId])
  @@index([authorId])
}

model Topo {
  id        String      @id @default(uuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  Wall      Wall        @relation(fields: [wallId], references: [id])
  wallId    String
  position  Int         @default(0)
  main      Boolean     @default(false)
  name      String?
  RoutePath RoutePath[]
  canvas    String?     @db.LongText
  image     Image       @relation(fields: [imageId], references: [id])
  imageId   String
  Author    User        @relation("AuthorTopo", fields: [authorId], references: [id])
  authorId  String
  coAuthors User[]      @relation("CoAuthorTopo")

  @@index([wallId])
  @@index([imageId])
  @@index([authorId])
}

model Route {
  id           String      @id @default(uuid())
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  name         String
  position     Int         @default(0)
  leftRouteId  String?
  rightRouteId String?
  classic      Boolean     @default(false)
  kind         RouteKind
  Wall         Wall        @relation(fields: [wallId], references: [id], onDelete: Cascade)
  wallId       String
  description  String?     @db.LongText
  RoutePath    RoutePath[]
  RouteGrade   RouteGrade?
  Author       User        @relation("AuthorRoute", fields: [authorId], references: [id])
  authorId     String
  coAuthors    User[]      @relation("CoAuthorRoute")

  @@index([wallId])
  @@index([authorId])
}

model RouteGrade {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  grade      Int?
  project    Boolean  @default(false)
  slashGrade Boolean  @default(false)
  route      Route    @relation(fields: [routeId], references: [id])
  routeId    String   @unique

  @@index([routeId])
}

model RoutePath {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  path      String   @db.LongText
  Topo      Topo     @relation(fields: [topoId], references: [id], onDelete: Cascade)
  topoId    String
  Route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  routeId   String
  Author    User     @relation("AuthorRoutePath", fields: [authorId], references: [id])
  authorId  String
  coAuthors User[]   @relation("CoAuthorRoutePath")

  @@index([topoId])
  @@index([routeId])
  @@index([authorId])
}

model Image {
  id             String         @id @default(uuid())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  height         Int
  width          Int
  url            String         @db.LongText
  storageService StorageService
  bytes          BigInt?
  publicId       String?        @db.MediumText
  version        BigInt?
  assetId        String?        @db.MediumText
  format         String?
  Topo           Topo[]
  User           User[]
  Zone           Zone?          @relation(fields: [zoneId], references: [id])
  zoneId         String?
}

enum InfoAccess {
  Public
  Community
  Private
}

enum RouteKind {
  Sport
  Trad
  Boulder
  Mixed
  Ice
}

enum StorageService {
  Cloudinary
}
